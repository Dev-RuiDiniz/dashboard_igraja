@using IgrejaSocial.Domain.Entities
@using IgrejaSocial.Domain.Enums
@inject EmprestimoService EmprestimoService

<MudDialog>
    <DialogContent>
        <MudStack Spacing="2">
            <MudText Typo="Typo.subtitle1">@($"{Equipamento?.CodigoPatrimonio} - {Equipamento?.Descricao}")</MudText>

            <MudDatePicker Label="Data de devolução"
                           @bind-Date="_dataDevolucao"
                           MinDate="@DateTime.Today"
                           Dense="true"
                           Required="true"
                           Validation="ValidarDataDevolucao" />

            <MudSelect T="EstadoConservacao" Label="Estado físico" Dense="true" @bind-Value="_estadoConservacao">
                @foreach (var estado in _estados)
                {
                    <MudSelectItem Value="@estado">@estado.ToString()</MudSelectItem>
                }
            </MudSelect>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="Cancelar">Cancelar</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RegistrarDevolucao">Confirmar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Equipamento? Equipamento { get; set; }
    [Parameter] public Guid RegistroId { get; set; }

    private DateTime? _dataDevolucao = DateTime.Today;
    private EstadoConservacao _estadoConservacao = EstadoConservacao.Bom;
    private readonly EstadoConservacao[] _estados = Enum.GetValues<EstadoConservacao>();

    private string? ValidarDataDevolucao(DateTime? data)
    {
        if (!data.HasValue)
        {
            return "Informe a data de devolução.";
        }

        if (data.Value.Date < DateTime.Today)
        {
            return "A data não pode ser retroativa.";
        }

        return null;
    }

    private async Task RegistrarDevolucao()
    {
        if (!RegistroId.Equals(Guid.Empty) && _dataDevolucao.HasValue)
        {
            var sucesso = await EmprestimoService.RegistrarDevolucaoAsync(RegistroId, _dataDevolucao.Value, _estadoConservacao);
            if (sucesso)
            {
                MudDialog.Close(DialogResult.Ok(true));
            }
        }
    }

    private void Cancelar() => MudDialog.Cancel();
}
