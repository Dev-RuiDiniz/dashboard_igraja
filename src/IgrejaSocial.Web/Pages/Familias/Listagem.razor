@page "/familias"
@using System.Globalization
@using IgrejaSocial.Domain.Entities
@inject IDialogService DialogService
@inject FamiliaService FamiliaService

<MudText Typo="Typo.h4" Class="mb-4">Gerenciamento de Famílias</MudText>

<MudTable Items="@_familias" Hover="true" Striped="true" Filter="new Func<Familia,bool>(FilterFunc1)" T="Familia" Elevation="2">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Famílias Cadastradas</MudText>
        
        @* BOTÃO PARA NOVO CADASTRO: Chama o método OpenDialog *@
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   StartIcon="@Icons.Material.Filled.Add" 
                   OnClick="OpenDialog" 
                   Class="ml-4">
            Nova Família
        </MudButton>

        <MudSpacer />

        @* FILTROS: CPF/RG, Bairro e Renda *@
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mt-0">
            <MudTextField @bind-Value="_searchCpfRg"
                          Placeholder="Buscar por CPF/RG"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Badge"
                          IconSize="Size.Medium" />
            <MudTextField @bind-Value="_searchBairro"
                          Placeholder="Buscar por Bairro"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.LocationOn"
                          IconSize="Size.Medium" />
            <MudTextField @bind-Value="_searchRenda"
                          Placeholder="Buscar por Renda"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Payments"
                          IconSize="Size.Medium" />
        </MudStack>
    </ToolBarContent>

    <HeaderContent>
        <MudTh>Responsável</MudTh>
        <MudTh>CPF</MudTh>
        <MudTh>RG</MudTh>
        <MudTh>Docs</MudTh>
        <MudTh>Endereço</MudTh>
        <MudTh>Bairro</MudTh>
        <MudTh>Renda Per Capita</MudTh>
        <MudTh>Vulnerabilidade</MudTh>
        <MudTh>Ações</MudTh>
    </HeaderContent>

    <RowTemplate>
        <MudTd DataLabel="Responsável">@context.NomeResponsavel</MudTd>
        <MudTd DataLabel="CPF">
            @(long.TryParse(context.CpfResponsavel, out var cpf) 
                ? string.Format("{0:000\\.000\\.000-00}", cpf) 
                : context.CpfResponsavel)
        </MudTd>
        <MudTd DataLabel="RG">@context.RgResponsavel</MudTd>
        <MudTd DataLabel="Docs">
            @if (!context.DocumentacaoApresentada)
            {
                <MudTooltip Text="Documentação pendente">
                    <MudIcon Icon="@Icons.Material.Filled.ReportProblem" Color="Color.Warning" />
                </MudTooltip>
            }
            else
            {
                <MudTooltip Text="Documentação conferida">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                </MudTooltip>
            }
        </MudTd>
        <MudTd DataLabel="Endereço">@context.Endereco</MudTd>
        <MudTd DataLabel="Bairro">@GetBairro(context.Endereco)</MudTd>
        <MudTd DataLabel="Renda">@context.RendaPerCapita.ToString("C")</MudTd>
        <MudTd DataLabel="Status">
            @* CHIP DINÂMICO: Verde/Amarelo/Vermelho baseado na renda per capita *@
            <MudChip T="string"
                     Color="@GetVulnerabilidadeColor(context)"
                     Size="Size.Small"
                     Variant="Variant.Text">
                @GetVulnerabilidadeLabel(context)
            </MudChip>
        </MudTd>
        <MudTd>
            <MudIconButton Icon="@Icons.Material.Filled.ShoppingBasket" Color="Color.Success" Size="Size.Small" Title="Registrar entrega de cesta"
                           OnClick="@(() => OpenEntregaCestaDialog(context))" />
            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Info" Size="Size.Small" Title="Ver Detalhes"
                           OnClick="@(() => OpenHistoricoDialog(context))" />
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" Title="Editar" />
        </MudTd>
    </RowTemplate>

    <PagerContent>
        <MudTablePager InfoFormat="Exibindo {first_item}-{last_item} de {all_items}" RowsPerPageString="Linhas por página:" />
    </PagerContent>
</MudTable>

@code {
    private string _searchCpfRg = "";
    private string _searchBairro = "";
    private string _searchRenda = "";
    private List<Familia> _familias = new();

    // Carrega os dados da API ao iniciar a página
    protected override async Task OnInitializedAsync()
    {
        _familias = await FamiliaService.GetFamiliasAsync();
    }

    // Método disparado pelo botão "Nova Família"
    private async Task OpenDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        
        // Exibe o modal FamiliaDialog (que criamos anteriormente)
        var dialog = await DialogService.ShowAsync<FamiliaDialog>("Cadastrar Nova Família", options);
        var result = await dialog.Result;

        // Se o usuário salvou com sucesso no modal, recarregamos a lista
        if (!result.Canceled)
        {
            _familias = await FamiliaService.GetFamiliasAsync();
        }
    }

    private async Task OpenHistoricoDialog(Familia familia)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var parameters = new DialogParameters
        {
            { "FamiliaSelecionada", familia }
        };

        await DialogService.ShowAsync<FamiliaDialog>("Detalhes da Família", parameters, options);
    }

    private async Task OpenEntregaCestaDialog(Familia familia)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var parameters = new DialogParameters
        {
            { "FamiliaSelecionada", familia }
        };

        var dialog = await DialogService.ShowAsync<EntregaCestaDialog>("Registrar entrega de cesta", parameters, options);
        await dialog.Result;
    }

    // Lógica de filtro da MudTable
    private bool FilterFunc1(Familia familia) => FilterFunc(familia);

    private bool FilterFunc(Familia familia)
    {
        if (!string.IsNullOrWhiteSpace(_searchCpfRg))
        {
            if (!(familia.CpfResponsavel?.Contains(_searchCpfRg, StringComparison.OrdinalIgnoreCase) ?? false) &&
                !(familia.RgResponsavel?.Contains(_searchCpfRg, StringComparison.OrdinalIgnoreCase) ?? false))
            {
                return false;
            }
        }

        if (!string.IsNullOrWhiteSpace(_searchBairro))
        {
            var bairro = GetBairro(familia.Endereco);
            if (!(bairro?.Contains(_searchBairro, StringComparison.OrdinalIgnoreCase) ?? false) &&
                !(familia.Endereco?.Contains(_searchBairro, StringComparison.OrdinalIgnoreCase) ?? false))
            {
                return false;
            }
        }

        if (!string.IsNullOrWhiteSpace(_searchRenda))
        {
            var rendaOk = false;
            var rendaFormatada = familia.RendaPerCapita.ToString("C", CultureInfo.GetCultureInfo("pt-BR"));
            if (rendaFormatada.Contains(_searchRenda, StringComparison.OrdinalIgnoreCase))
            {
                rendaOk = true;
            }

            if (!rendaOk &&
                decimal.TryParse(_searchRenda, NumberStyles.Any, CultureInfo.GetCultureInfo("pt-BR"), out var rendaFiltro))
            {
                rendaOk = familia.RendaPerCapita >= rendaFiltro;
            }

            if (!rendaOk)
            {
                return false;
            }
        }

        return true;
    }

    private static string GetBairro(string endereco)
    {
        if (string.IsNullOrWhiteSpace(endereco)) return string.Empty;

        var partes = endereco.Split(',');
        if (partes.Length < 2) return string.Empty;

        var possivelBairro = partes[1].Trim();
        var separador = possivelBairro.IndexOf(" - ", StringComparison.Ordinal);
        return separador > 0 ? possivelBairro[..separador].Trim() : possivelBairro;
    }

    private static Color GetVulnerabilidadeColor(Familia familia)
    {
        if (familia.RendaPerCapita <= 218) return Color.Error;
        if (familia.IsVulneravel) return Color.Warning;
        return Color.Success;
    }

    private static string GetVulnerabilidadeLabel(Familia familia)
    {
        if (familia.RendaPerCapita <= 218) return "Extrema Pobreza";
        if (familia.IsVulneravel) return "Vulnerável";
        return "Estável";
    }
}
