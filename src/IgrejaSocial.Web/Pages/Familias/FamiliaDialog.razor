@using System.Linq
@using MudBlazor
@using MudBlazor.Services
@using IgrejaSocial.Domain.Entities
@using IgrejaSocial.Domain.Enums
@using IgrejaSocial.Domain.Models
@using IgrejaSocial.Web.Models

@inject FamiliaService FamiliaService
@inject EmprestimoService EmprestimoService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <div class="d-flex align-center justify-space-between w-100">
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.GroupAdd" Class="mr-3 mb-n1" />
                Cadastro de Família
            </MudText>
            
            @* TAREFA 9: Status Visual de Vulnerabilidade em Tempo Real *@
            <div class="mr-4">
                @if (_familia.RendaPerCapita > 0)
                {
                    @if (_familia.RendaPerCapita <= 218)
                    {
                        <MudChip T="string" Color="Color.Error" Variant="Variant.Filled" Size="Size.Small">Extrema Pobreza</MudChip>
                    }
                    else if (_familia.IsVulneravel)
                    {
                        <MudChip T="string" Color="Color.Warning" Variant="Variant.Filled" Size="Size.Small">Vulnerável</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Success" Variant="Variant.Filled" Size="Size.Small">Estável</MudChip>
                    }
                }
            </div>
        </div>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@_success">
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">

                @* ABA 1: DADOS DO RESPONSÁVEL (Task 7) *@
                <MudTabPanel Text="Responsável" Icon="@Icons.Material.Filled.Person">
                    <MudGrid>
                        <MudItem xs="12" md="8">
                            <MudTextField T="string" Label="Nome do Responsável" Required="true"
                                          @bind-Value="_familia.NomeResponsavel" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField T="string" Label="CPF" Mask="@(new PatternMask("000.000.000-00"))"
                                          @bind-Value="_familia.CpfResponsavel" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField T="string" Label="RG" Mask="@(new PatternMask("00.000.000-0"))"
                                          @bind-Value="_familia.RgResponsavel" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudDatePicker Label="Nascimento" @bind-Date="_dataNascimentoResponsavel" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField T="string" Label="Telefone" Mask="@(new PatternMask("(00) 00000-0000"))"
                                          @bind-Value="_familia.TelefoneContato" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudSelect T="TipoMoradia" Label="Tipo de Moradia" @bind-Value="_familia.Residencia" Variant="Variant.Outlined">
                                @foreach (TipoMoradia item in Enum.GetValues(typeof(TipoMoradia)))
                                {
                                    <MudSelectItem Value="@item">@item.ToString()</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudSelect T="StatusAcompanhamento" Label="Status do Acompanhamento" @bind-Value="_familia.Status" Variant="Variant.Outlined">
                                @foreach (StatusAcompanhamento item in Enum.GetValues(typeof(StatusAcompanhamento)))
                                {
                                    <MudSelectItem Value="@item">@item.ToString()</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField T="string" Label="CEP" @bind-Value="_cepBusca" TextChanged="OnCepChanged"
                                          Mask="@(new PatternMask("00000-000"))" Variant="Variant.Outlined"
                                          Adornment="Adornment.End"
                                          AdornmentIcon="@(_loadingCep ? Icons.Material.Filled.HourglassEmpty : Icons.Material.Filled.Search)" />
                        </MudItem>
                        <MudItem xs="12" md="8">
                            <MudTextField T="string" Label="Endereço Completo" @bind-Value="_familia.Endereco"
                                          Variant="Variant.Outlined" Required="true" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField T="decimal" Label="Renda Base do Responsável" @bind-Value="_familia.RendaFamiliarTotal"
                                             Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentText="R$" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField T="string" Label="Observações" Lines="3" TextArea="true"
                                          @bind-Value="_familia.Observacoes" Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                @* ABA 2: MEMBROS E DEPENDENTES (Task 8) *@
                <MudTabPanel Text="Membros" Icon="@Icons.Material.Filled.People">
                    <MudPaper Class="pa-4 mb-4" Elevation="0" Style="background-color: var(--mud-palette-background-grey)">
                        <MudGrid>
                            <MudItem xs="12" md="4">
                                <MudTextField T="string" Label="Nome" @bind-Value="_novoMembro.Nome" 
                                              Variant="Variant.Outlined" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6" md="4">
                                <MudSelect T="TipoParentesco" Label="Parentesco" @bind-Value="_novoMembro.Parentesco" 
                                           Variant="Variant.Outlined" Margin="Margin.Dense">
                                    @foreach (TipoParentesco item in Enum.GetValues(typeof(TipoParentesco)))
                                    {
                                        if (item != TipoParentesco.Responsavel)
                                        {
                                            <MudSelectItem Value="@item">@item.ToString()</MudSelectItem>
                                        }
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="6" md="4">
                                <MudNumericField T="decimal" Label="Renda" @bind-Value="_novoMembro.RendaIndividual" 
                                                Variant="Variant.Outlined" Margin="Margin.Dense" Adornment="Adornment.Start" AdornmentText="R$" />
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudSelect T="GrauInstrucao" Label="Escolaridade" @bind-Value="_novoMembro.NivelEscolar" Variant="Variant.Outlined" Margin="Margin.Dense">
                                    @foreach (GrauInstrucao item in Enum.GetValues(typeof(GrauInstrucao)))
                                    {
                                        <MudSelectItem Value="@item">@item.ToString()</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudSelect T="StatusOcupacional" Label="Trabalho" @bind-Value="_novoMembro.SituacaoTrabalho" Variant="Variant.Outlined" Margin="Margin.Dense">
                                    @foreach (StatusOcupacional item in Enum.GetValues(typeof(StatusOcupacional)))
                                    {
                                        <MudSelectItem Value="@item">@item.ToString()</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudDatePicker Label="Nascimento" @bind-Date="_dataNascimentoMembro" Variant="Variant.Outlined" Margin="Margin.Dense" />
                            </MudItem>

                            <MudItem xs="12" Class="d-flex justify-end">
                                <MudButton StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary" 
                                           Variant="Variant.Filled" OnClick="AdicionarMembro">
                                    Adicionar à Lista
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>

                    <MudTable Items="@_familia.Membros" Hover="true" Dense="true" Elevation="0" Striped="true">
                        <HeaderContent>
                            <MudTh>Nome</MudTh>
                            <MudTh>Parentesco</MudTh>
                            <MudTh>Renda</MudTh>
                            <MudTh>Ação</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Nome</MudTd>
                            <MudTd>@context.Parentesco</MudTd>
                            <MudTd>@context.RendaIndividual.ToString("C")</MudTd>
                            <MudTd>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" 
                                               Size="Size.Small" OnClick="@(() => RemoverMembro(context))" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudTabPanel>

                @* ABA 3: HISTÓRICO *@
                <MudTabPanel Text="Histórico" Icon="@Icons.Material.Filled.History">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.subtitle1">Equipamentos emprestados</MudText>

                        <MudTable Items="@_historico" Dense="true" Hover="true" Striped="true" Elevation="0">
                            <HeaderContent>
                                <MudTh>Equipamento</MudTh>
                                <MudTh>Empréstimo</MudTh>
                                <MudTh>Previsão</MudTh>
                                <MudTh>Devolução</MudTh>
                                <MudTh>Estado</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@context.CodigoPatrimonio</MudTd>
                                <MudTd>@context.DataEmprestimo.ToString("dd/MM/yyyy")</MudTd>
                                <MudTd>@context.DataPrevistaDevolucao.ToString("dd/MM/yyyy")</MudTd>
                                <MudTd>@(context.DataDevolucao?.ToString("dd/MM/yyyy") ?? "-")</MudTd>
                                <MudTd>@(context.EstadoConservacao?.ToString() ?? "-")</MudTd>
                            </RowTemplate>
                        </MudTable>

                        @if (!_historico.Any())
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Nenhum empréstimo registrado.</MudText>
                        }
                    </MudStack>
                </MudTabPanel>
            </MudTabs>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancelar</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" 
                   Disabled="@(!_success)" OnClick="Submit">Finalizar Cadastro</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public MudDialogInstance? MudDialog { get; set; }

    private MudForm? form;
    private bool _success;
    private bool _loadingCep;
    private string _cepBusca = string.Empty;
    private DateTime? _dataNascimentoMembro = DateTime.Today.AddYears(-20);
    private DateTime? _dataNascimentoResponsavel = DateTime.Today.AddYears(-30);
    
    [Parameter] public Familia? FamiliaSelecionada { get; set; }

    private Familia _familia = new() { Membros = new List<MembroFamilia>() };
    private List<HistoricoEmprestimoDto> _historico = new();

    protected override async Task OnInitializedAsync()
    {
        if (FamiliaSelecionada is not null)
        {
            _familia = FamiliaSelecionada;
            await CarregarHistoricoAsync();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (FamiliaSelecionada is not null && _familia.Id != FamiliaSelecionada.Id)
        {
            _familia = FamiliaSelecionada;
            await CarregarHistoricoAsync();
        }
    }

    private async Task CarregarHistoricoAsync()
    {
        _historico = await EmprestimoService.ListarHistoricoFamiliaAsync(_familia.Id);
    }
    private MembroFamilia _novoMembro = new();

    private void AdicionarMembro() {
        if (!string.IsNullOrWhiteSpace(_novoMembro.Nome)) {
            _familia.Membros.Add(new MembroFamilia { 
                Id = Guid.NewGuid(),
                Nome = _novoMembro.Nome, 
                Parentesco = _novoMembro.Parentesco,
                RendaIndividual = _novoMembro.RendaIndividual,
                NivelEscolar = _novoMembro.NivelEscolar,
                SituacaoTrabalho = _novoMembro.SituacaoTrabalho,
                DataNascimento = _dataNascimentoMembro ?? DateTime.Today
            });
            
            _novoMembro = new MembroFamilia(); 
            _dataNascimentoMembro = DateTime.Today.AddYears(-20);
            Snackbar.Add("Membro adicionado.", Severity.Info);
        }
    }

    private void RemoverMembro(MembroFamilia membro) => _familia.Membros.Remove(membro);

    private async Task OnCepChanged(string val) {
        if (val?.Length == 9) {
            _loadingCep = true;
            try {
                var dados = await FamiliaService.ConsultarCepAsync(val);
                if (dados != null && !string.IsNullOrEmpty(dados.Logradouro)) {
                    _familia.Endereco = $"{dados.Logradouro}, {dados.Bairro} - {dados.Localidade}/{dados.Uf}";
                    Snackbar.Add("Endereço preenchido!", Severity.Success);
                }
            }
            finally { 
                _loadingCep = false; 
                StateHasChanged(); 
            }
        }
    }

    private void Cancel() => MudDialog?.Cancel();

    private async Task Submit() {
        if (form is not null) await form.Validate();
        if (form?.IsValid == true)
        {
            _familia.DataNascimentoResponsavel = _dataNascimentoResponsavel;

            var sucesso = await FamiliaService.CriarFamiliaAsync(_familia);
            if (sucesso)
            {
                MudDialog?.Close(DialogResult.Ok(_familia));
            }
        }
    }
}
