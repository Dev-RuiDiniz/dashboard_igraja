@using IgrejaSocial.Domain.Entities
@using IgrejaSocial.Domain.Enums
@using IgrejaSocial.Domain.Models
@using MudBlazor @* ESSENCIAL: Resolve o erro CS0246 do MudDialogInstance *@
@inject FamiliaService FamiliaService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Class="mr-3 mb-n1" />
            Nova Família
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@_success">
            <MudGrid>
                @* Campo de Nome e CPF *@
                <MudItem xs="12" md="8">
                    <MudTextField T="string" Label="Nome do Responsável" Required="true" 
                                  @bind-Value="_familia.NomeResponsavel" 
                                  For="@(() => _familia.NomeResponsavel)" 
                                  Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudTextField T="string" Label="CPF" Required="true" 
                                  Mask="@(new PatternMask("000.000.000-00"))"
                                  @bind-Value="_familia.CpfResponsavel" 
                                  For="@(() => _familia.CpfResponsavel)" 
                                  Variant="Variant.Outlined" />
                </MudItem>

                @* Campo de CEP com Busca Automática *@
                <MudItem xs="12" md="4">
                    <MudTextField T="string" Label="CEP" 
                                  @bind-Value="_cepBusca" 
                                  Mask="@(new PatternMask("00000-000"))"
                                  TextChanged="OnCepChanged"
                                  Adornment="Adornment.End" 
                                  AdornmentIcon="@(_loadingCep ? Icons.Material.Filled.HourglassEmpty : Icons.Material.Filled.Map)"
                                  Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" md="8">
                    <MudTextField T="string" Label="Endereço Completo" Required="true"
                                  @bind-Value="_familia.Endereco" 
                                  For="@(() => _familia.Endereco)" 
                                  Variant="Variant.Outlined" />
                </MudItem>

                @* Outros campos (Renda, Telefone, etc) devem seguir abaixo... *@
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancelar</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" 
                   Disabled="@(!_success || _loadingCep)" OnClick="Submit">Salvar Família</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    public MudDialogInstance? MudDialog { get; set; } 
    
    private MudForm? form; 
    private bool _success;
    private bool _loadingCep;
    private string _cepBusca = string.Empty; 
    private Familia _familia = new();

    private async Task OnCepChanged(string val)
    {
        if (string.IsNullOrWhiteSpace(val)) return;
        
        var somenteNumeros = new string(val.Where(char.IsDigit).ToArray());

        if (somenteNumeros.Length == 8)
        {
            _loadingCep = true;
            try 
            {
                var dadosCep = await FamiliaService.ConsultarCepAsync(somenteNumeros);
                
                // CORREÇÃO DE ANULABILIDADE: Verifica se o objeto e a propriedade não são nulos
                if (dadosCep is not null && !string.IsNullOrEmpty(dadosCep.Logradouro))
                {
                    // Acesso seguro às propriedades do DTO
                    _familia.Endereco = $"{dadosCep.Logradouro}, {dadosCep.Bairro} - {dadosCep.Localidade}/{dadosCep.Uf}";
                    Snackbar.Add("Endereço preenchido!", Severity.Info);
                }
            }
            finally 
            {
                _loadingCep = false;
            }
        }
    }

    private void Cancel() => MudDialog?.Cancel();

    private async Task Submit()
    {
        // Uso do padrão 'is not null' para evitar warnings de referência nula
        if (form is not null) 
        {
            await form.Validate();
            
            if (form.IsValid)
            {
                Snackbar.Add("Família cadastrada com sucesso!", Severity.Success);
                MudDialog?.Close(DialogResult.Ok(_familia));
            }
        }
    }
}