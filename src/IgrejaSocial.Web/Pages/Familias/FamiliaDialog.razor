@using IgrejaSocial.Domain.Entities
@using IgrejaSocial.Domain.Enums
@using IgrejaSocial.Domain.DTOs
@inject FamiliaService FamiliaService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Class="mr-3 mb-n1" />
            Nova Família
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@_success">
            <MudGrid>
                @* Nome e CPF *@
                <MudItem xs="12" md="8">
                    <MudTextField T="string" Label="Nome do Responsável" Required="true" 
                                  @bind-Value="_familia.NomeResponsavel" 
                                  For="@(() => _familia.NomeResponsavel)" 
                                  Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudTextField T="string" Label="CPF" Required="true" 
                                  Mask="@(new PatternMask("000.000.000-00"))"
                                  @bind-Value="_familia.CpfResponsavel" 
                                  For="@(() => _familia.CpfResponsavel)" 
                                  Variant="Variant.Outlined" />
                </MudItem>

                @* --- INTEGRAÇÃO VIACEP --- *@
                @* Campo de CEP que dispara a busca automática *@
                <MudItem xs="12" md="4">
                    <MudTextField T="string" Label="CEP" 
                                  @bind-Value="_cepBusca" 
                                  Mask="@(new PatternMask("00000-000"))"
                                  OnInternalInputChanged="OnCepChanged"
                                  Adornment="Adornment.End" 
                                  AdornmentIcon="@(_loadingCep ? Icons.Material.Filled.HourglassEmpty : Icons.Material.Filled.Map)"
                                  Variant="Variant.Outlined" 
                                  HelperText="Digite o CEP para preencher o endereço"/>
                </MudItem>

                <MudItem xs="12" md="8">
                    <MudTextField T="string" Label="Endereço Completo" Required="true"
                                  @bind-Value="_familia.Endereco" 
                                  For="@(() => _familia.Endereco)" 
                                  Variant="Variant.Outlined" />
                </MudItem>

                @* Renda e Telefone *@
                <MudItem xs="12" md="6">
                    <MudNumericField T="decimal" Label="Renda Familiar Total" 
                                     Format="C2" Culture="@System.Globalization.CultureInfo.GetCultureInfo("pt-BR")"
                                     @bind-Value="_familia.RendaFamiliarTotal" 
                                     Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField T="string" Label="Telefone" 
                                  Mask="@(new PatternMask("(00) 00000-0000"))"
                                  @bind-Value="_familia.TelefoneContato" 
                                  Variant="Variant.Outlined" />
                </MudItem>

                @* Tipo de Residência e Observações *@
                <MudItem xs="12" md="6">
                    <MudSelect T="TipoResidencia" Label="Tipo de Residência" 
                               @bind-Value="_familia.Residencia" 
                               Variant="Variant.Outlined">
                        @foreach (TipoResidencia item in Enum.GetValues(typeof(TipoResidencia)))
                        {
                            <MudSelectItem Value="@item">@item.ToString()</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    <MudTextField T="string" Label="Observações" Lines="3" 
                                  @bind-Value="_familia.Observacoes" 
                                  Variant="Variant.Outlined" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancelar</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" 
                   Disabled="@(!_success || _loadingCep)" OnClick="Submit">Salvar Família</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    
    private MudForm form;
    private bool _success;
    private bool _loadingCep;
    private string _cepBusca;
    private Familia _familia = new();

    // Método disparado ao digitar no campo de CEP
    private async Task OnCepChanged(string val)
    {
        _cepBusca = val;
        // Remove a máscara para validar o tamanho
        var somenteNumeros = new string(val.Where(char.IsDigit).ToArray());

        if (somenteNumeros.Length == 8)
        {
            _loadingCep = true;
            try 
            {
                // Chama o serviço que configuramos na Tarefa 7
                var dadosCep = await FamiliaService.ConsultarCepAsync(somenteNumeros);
                
                if (dadosCep != null && !string.IsNullOrEmpty(dadosCep.Logradouro))
                {
                    // Preenche o endereço formatado
                    _familia.Endereco = $"{dadosCep.Logradouro}, {dadosCep.Bairro} - {dadosCep.Localidade}/{dadosCep.Uf}";
                    Snackbar.Add("Endereço preenchido via CEP!", Severity.Info);
                }
            }
            finally 
            {
                _loadingCep = false;
            }
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Submit()
    {
        await form.Validate();

        if (form.IsValid)
        {
            try 
            {
                // Futuro: await FamiliaService.CreateAsync(_familia);
                Snackbar.Add($"Família de {_familia.NomeResponsavel} salva com sucesso!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(_familia));
            }
            catch (Exception ex)
            {
                Snackbar.Add("Erro ao salvar: " + ex.Message, Severity.Error);
            }
        }
    }
}