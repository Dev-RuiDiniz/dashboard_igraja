@using MudBlazor
@using MudBlazor.Services
@using IgrejaSocial.Domain.Entities
@using IgrejaSocial.Domain.Enums
@using IgrejaSocial.Domain.Models

@inject FamiliaService FamiliaService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.GroupAdd" Class="mr-3 mb-n1" />
            Cadastro de Família
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@_success">
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
                
                @* ABA 1: DADOS DO RESPONSÁVEL *@
                <MudTabPanel Text="Responsável" Icon="@Icons.Material.Filled.Person">
                    <MudGrid>
                        <MudItem xs="12" md="8">
                            <MudTextField T="string" Label="Nome do Responsável" Required="true" 
                                          @bind-Value="_familia.NomeResponsavel" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField T="string" Label="CPF" Mask="@(new PatternMask("000.000.000-00"))" 
                                          @bind-Value="_familia.CpfResponsavel" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField T="string" Label="CEP" @bind-Value="_cepBusca" TextChanged="OnCepChanged" 
                                          Mask="@(new PatternMask("00000-000"))" Variant="Variant.Outlined"
                                          Adornment="Adornment.End" 
                                          AdornmentIcon="@(_loadingCep ? Icons.Material.Filled.HourglassEmpty : Icons.Material.Filled.Search)" />
                        </MudItem>
                        <MudItem xs="12" md="8">
                            <MudTextField T="string" Label="Endereço Completo" @bind-Value="_familia.Endereco" 
                                          Variant="Variant.Outlined" Required="true" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                @* ABA 2: MEMBROS E DEPENDENTES (TAREFA 8) *@
                <MudTabPanel Text="Membros" Icon="@Icons.Material.Filled.People">
                    <MudPaper Class="pa-4 mb-4" Elevation="0" Style="background-color: var(--mud-palette-background-grey)">
                        <MudGrid>
                            <MudItem xs="12" md="4">
                                <MudTextField T="string" Label="Nome" @bind-Value="_novoMembro.Nome" 
                                              Variant="Variant.Outlined" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="6" md="4">
                                <MudSelect T="TipoParentesco" Label="Parentesco" @bind-Value="_novoMembro.Parentesco" 
                                           Variant="Variant.Outlined" Margin="Margin.Dense">
                                    @foreach (TipoParentesco item in Enum.GetValues(typeof(TipoParentesco)))
                                    {
                                        if (item != TipoParentesco.Responsavel)
                                        {
                                            <MudSelectItem Value="@item">@item.ToString()</MudSelectItem>
                                        }
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="6" md="4">
                                <MudNumericField T="decimal" Label="Renda Individual" @bind-Value="_novoMembro.RendaIndividual" 
                                                Variant="Variant.Outlined" Margin="Margin.Dense" Adornment="Adornment.Start" AdornmentText="R$" />
                            </MudItem>
                            
                            @* Campos adicionais necessários para a Entidade MembroFamilia *@
                            <MudItem xs="12" md="5">
                                <MudSelect T="Escolaridade" Label="Escolaridade" @bind-Value="_novoMembro.NivelEscolar" Variant="Variant.Outlined" Margin="Margin.Dense">
                                    @foreach (Escolaridade item in Enum.GetValues(typeof(Escolaridade)))
                                    {
                                        <MudSelectItem Value="@item">@item.ToString()</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudDatePicker Label="Data Nascimento" @bind-Date="_dataNascimentoMembro" Variant="Variant.Outlined" Margin="Margin.Dense" />
                            </MudItem>

                            <MudItem xs="12" md="3" Class="d-flex align-center">
                                <MudButton StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary" 
                                           Variant="Variant.Filled" OnClick="AdicionarMembro" FullWidth>
                                    Adicionar
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>

                    <MudTable Items="@_familia.Membros" Hover="true" Dense="true" Elevation="0" Striped="true">
                        <HeaderContent>
                            <MudTh>Nome</MudTh>
                            <MudTh>Parentesco</MudTh>
                            <MudTh>Renda</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Nome">@context.Nome</MudTd>
                            <MudTd DataLabel="Parentesco">@context.Parentesco</MudTd>
                            <MudTd DataLabel="Renda">@context.RendaIndividual.ToString("C")</MudTd>
                            <MudTd>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" 
                                               Size="Size.Small" OnClick="@(() => RemoverMembro(context))" />
                            </MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText Align="Align.Center" Class="pa-4">Nenhum dependente adicionado.</MudText>
                        </NoRecordsContent>
                    </MudTable>
                </MudTabPanel>
            </MudTabs>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancelar</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" 
                   Disabled="@(!_success)" OnClick="Submit">Salvar Família</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public MudDialogInstance? MudDialog { get; set; }

    private MudForm? form;
    private bool _success;
    private bool _loadingCep;
    private string _cepBusca = string.Empty;
    private DateTime? _dataNascimentoMembro = DateTime.Today.AddYears(-20);
    
    private Familia _familia = new() { Membros = new List<MembroFamilia>() };
    private MembroFamilia _novoMembro = new();

    private void AdicionarMembro() {
        if (!string.IsNullOrWhiteSpace(_novoMembro.Nome)) {
            // Criamos uma nova instância para evitar problemas de referência
            var membroParaAdicionar = new MembroFamilia { 
                Id = Guid.NewGuid(),
                Nome = _novoMembro.Nome, 
                Parentesco = _novoMembro.Parentesco,
                RendaIndividual = _novoMembro.RendaIndividual,
                NivelEscolar = _novoMembro.NivelEscolar,
                DataNascimento = _dataNascimentoMembro ?? DateTime.Today
            };

            _familia.Membros.Add(membroParaAdicionar);
            
            // Reset do formulário de novo membro
            _novoMembro = new MembroFamilia(); 
            _dataNascimentoMembro = DateTime.Today.AddYears(-20);
            
            Snackbar.Add("Membro adicionado à lista.", Severity.Info);
        }
        else {
            Snackbar.Add("Informe pelo menos o nome do membro.", Severity.Warning);
        }
    }

    private void RemoverMembro(MembroFamilia membro) => _familia.Membros.Remove(membro);

    private async Task OnCepChanged(string val) {
        if (val?.Length == 9) {
            _loadingCep = true;
            try {
                var dados = await FamiliaService.ConsultarCepAsync(val);
                if (dados != null && !string.IsNullOrEmpty(dados.Logradouro)) {
                    _familia.Endereco = $"{dados.Logradouro}, {dados.Bairro} - {dados.Localidade}/{dados.Uf}";
                    Snackbar.Add("Endereço localizado!", Severity.Success);
                }
            }
            catch {
                Snackbar.Add("Erro ao buscar CEP.", Severity.Error);
            }
            finally { 
                _loadingCep = false; 
                StateHasChanged(); // Força a atualização da UI para o loading sumir
            }
        }
    }

    private void Cancel() => MudDialog?.Cancel();

    private async Task Submit() {
        if (form is not null) await form.Validate();
        if (form?.IsValid == true) {
            MudDialog?.Close(DialogResult.Ok(_familia));
        }
    }
}